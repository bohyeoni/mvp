# 🤖 RAG 기반 광고분석 쿼리 어시스턴트

> SQL을 몰라도, 정의서를 열지 않아도,  
> 자연어로 광고 분석 데이터를 자유롭게 탐색할 수 있는 AI 쿼리 어시스턴트

---

## 🎯 서비스 목적

지니TV 광고분석 시스템은 **MSSQL**과 **NDAP(Hive)** 기반의 복수 데이터베이스를 운용하고 있으며, 테이블 구조와 쿼리 문법이 다르거나 일부 테이블은 특정 DB에만 존재하는 복잡한 환경이다.

이러한 환경에서도 **SQL을 잘 모르는 사용자**가 정의서를 보지 않고도 자연어로 광고 시청 데이터, VOD, 채널 시청 내역 등을 자유롭게 질의할 수 있도록 하는 **RAG 기반 AI 어시스턴트 시스템**을 구축한다.

---

## 🧠 문제 정의

| 문제 | 상세 설명 |
|------|-----------|
| SQL 작성 어려움 | 마케터나 기획자 등은 쿼리를 직접 구성하기 어려움 |
| 정의서 접근성 부족 | 테이블/컬럼을 확인하기 위해 수동 검색 또는 운영자 문의 필요 |
| 복수 DB 환경의 복잡성 | MSSQL, NDAP(Hive) 각각 다른 쿼리 문법과 테이블 구성 |
| 운영 부하 증가 | 반복적인 쿼리 요청·응답 비용 증가 |

---

## 🔍 사용자 시나리오 예시

- `"25년 6월 한 달간 채널광고 시청내역을 조회할 수 있는 쿼리를 만들어줘"`
- `"일자별 채널별 셋탑 수를 추출할 수 있는 테이블을 알려줘"`
- `"채널시청횟수는 컬럼명이 뭐야?"`

---

## 🧩 주요 기능

| 기능 | 설명 |
|------|------|
| 자연어 → SQL 쿼리 생성 | 사용자의 요구를 이해하고 실제 쿼리로 변환 |
| 메타데이터 검색 응답 | 정의서 없이도 테이블/컬럼/DB 존재 여부 안내 |
| 복수 DB 분기 처리 | MSSQL과 Hive에 따른 쿼리 스타일 자동 생성 |
| 테이블 소속 DB 식별 | 어떤 DB에 존재하는지 자동 안내 |
| 사용자 DB 선택 (선택 기능) | MSSQL 또는 NDAP 우선 선택 가능 (기본/옵션) |

---

## 🔧 기술 아키텍처

### 🛠 기술 스택 (2025.07 기준 / 예상 구성)

| 구성 요소 | 기술 / 설명 |
|-----------|-------------|
| LLM 기반 질의 생성 | **Azure OpenAI GPT-4o-mini** – 자연어 질문 이해 및 SQL 생성 |
| 임베딩 모델 (텍스트 벡터화) | **text-embedding-3-small** (Azure) |
| 검색 엔진 (RAG) | 메타데이터 벡터 검색 기반 RAG 구성 |
| 메타데이터 소스 | 광고분석시스템 정의서 (엑셀 또는 텍스트 파일에서 추출) |
| 메타데이터 저장 포맷 | 정제된 text 파일 – 테이블/컬럼명/설명 구조화 |
| 데이터 소스 | **(향후 연동 예정)** MSSQL, NDAP(Hive) – 실제 광고 분석 데이터 저장소 |
| 프론트엔드 | **Streamlit** – 사용자의 질문 입력 및 결과 시각화를 위한 경량 UI |

---

## 📂 메타데이터 구조 예시

| 엔티티명 |테이블명 | 속성명 | 칼럼명 | 자료형 | DB |
|------|------|------|------|------|-----|
|tv_채널광고노출이력|in_otv_cntpnt_advr_log_hist|기준일자|base_date|string|NDAP, MSSQL|
|tv_채널광고노출이력|in_otv_cntpnt_advr_log_hist|광고편성ID|frmtn_id|string|NDAP, MSSQL|
|tv_채널광고노출이력|in_otv_cntpnt_advr_log_hist|시작일시|strt_dt|string|NDAP, MSSQL|
|tv_채널광고노출이력|in_otv_cntpnt_advr_log_hist|시청비율|plyb_rati|int|NDAP, MSSQL|
...

* 엑셀 형태의 속성 정의서를 기반으로 사용
* 각 테이블은 어느 DB에 존재하는지 명시
* 문법 차이 반영: `LIMIT vs TOP`, `TO_DATE vs CAST`, `JOIN 방식` 등

---

## 🔄 MSSQL vs Hive 쿼리 분기 처리 예시

| 항목      | MSSQL                       | Hive                         |
| ------- | --------------------------- | ---------------------------- |
| 상위 10건  | `SELECT TOP 10 * FROM ...`  | `SELECT * FROM ... LIMIT 10` |
| 날짜 필터   | `CAST(date_column AS DATE)` | `TO_DATE(date_column)`       |
| 문자열 합치기 | `+` 연산                      | `CONCAT()`                   |
| NULL 필터 | `IS NULL / IS NOT NULL`     | 동일                           |


---

## 🏗️ 시스템 구성도

```plaintext
[ 사용자 ]
   │
   ▼
[ 프론트엔드 UI ]
   │
   ▼
[ AI Service ]
   │
   └─> RAG Retriever: 메타데이터에서 테이블/컬럼/DB 구조 검색
         │
         ▼
[ MSSQL or Hive SQL 생성 ]
         │
         ▼
결과 쿼리 반환 or 실행
```

---

## 💡 기대 효과

* SQL 작성이 어려운 사용자도 분석 가능
* 운영자 업무 부담 감소 (정의서·쿼리 문의 제거, 자료요청 효율화)
* MSSQL, Hive 양쪽 DB 환경에서의 유연한 분석 지원
* 테이블 존재 여부 및 문법 차이를 자동 처리

---

## 📝 향후 확장 방향

* 쿼리 결과 자동 시각화 (Graph + Table)
* Power BI, Looker 등 BI 도구와 연동
* 사용자 맞춤형 질의 히스토리 분석
* 사전 등록된 쿼리 템플릿 추천 기능

---

## 결과
https://ktds301-web-001-f8dha3cbfxgdfbem.canadacentral-01.azurewebsites.net/
<img src="https://github.com/user-attachments/assets/f8bd8f65-21ae-4de2-9f45-92c729dba252">
```
